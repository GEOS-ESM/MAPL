version: 2.1

orbs:
  ci: geos-esm/circleci-tools@1

workflows:
  build-and-test:
    jobs:

      # Builds MAPL in a "default" way
      - ci/build:
          name: build-and-test-MAPL-on-<< matrix.compiler >>
          context:
            - docker-hub-creds
          matrix:
            parameters:
              compiler: [gfortran, ifort]
          repo: MAPL
          mepodevelop: false
          run_unit_tests: true
          ctest_options: "-R MAPL -LE PERFORMANCE --output-on-failure"

      # Builds MAPL like UFS does (no FLAP and pFlogger, static)
      - ci/build:
          name: build-UFS-MAPL-on-<< matrix.compiler >>
          context:
            - docker-hub-creds
          matrix:
            parameters:
              compiler: [ifort]
          repo: MAPL
          mepodevelop: false
          extra_cmake_options: "-DBUILD_WITH_FLAP=OFF -DBUILD_WITH_PFLOGGER=OFF -DBUILD_SHARED_MAPL=OFF"
          run_unit_tests: true
          ctest_options: "-R MAPL -LE PERFORMANCE --output-on-failure"

      # Build GEOSgcm
      - ci/build:
          name: build-GEOSgcm-on-<< matrix.compiler >>
          context:
            - docker-hub-creds
          matrix:
            parameters:
              compiler: [gfortran, ifort]
          repo: GEOSgcm
          checkout_fixture: true
          mepodevelop: true
          checkout_mapl_branch: true
          persist_workspace: false # Needs to be true to run fv3/gcm experiment, costs extra

      # Build GEOSldas
      - ci/build:
          name: build-GEOSldas-on-<< matrix.compiler >>
          context:
            - docker-hub-creds
          matrix:
            parameters:
              compiler: [gfortran, ifort]
          repo: GEOSldas
          mepodevelop: false
          checkout_fixture: true
          fixture_branch: develop
          checkout_mapl_branch: true

      # Build GEOSadas (ifort only, needs a couple develop branches)
      - ci/build:
          name: build-GEOSadas-on-<< matrix.compiler >>
          context:
            - docker-hub-creds
          matrix:
            parameters:
              compiler: [ifort]
          resource_class: xlarge
          repo: GEOSadas
          checkout_fixture: true
          # This branch on GEOSadas will be used to track subrepos needed
          # for GEOSadas + MAPL develop much like how we do with MAPL 3
          fixture_branch: feature/mathomp4/mapldevelop
          checkout_mapl_branch: true
          mepodevelop: false
          rebuild_procs: 8

      ##################################################
      # - ci/run_fv3:                                  #
      #     name: run-FV3-on-<< matrix.compiler >>     #
      #     context:                                   #
      #       - docker-hub-creds                       #
      #     matrix:                                    #
      #       parameters:                              #
      #         compiler: [gfortran, ifort]            #
      #     requires:                                  #
      #       - build-GEOSgcm-on-<< matrix.compiler >> #
      #     repo: GEOSgcm                              #
      ##################################################

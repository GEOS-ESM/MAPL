#include "MAPL_TestErr.h"

module Test_WeightComputation

   use mapl3g_CSR_SparseMatrix
   use mapl3g_WeightComputation, only: compute_linear_map_fixedlevels_to_fixedlevels
   use mapl3g_WeightComputation, only: apply_linear_map
   use funit
   use, intrinsic :: iso_fortran_env, only: REAL32

   implicit none

contains

   @test
   subroutine test_linear_map_fixedlevels_to_fixedlevels()

      ! type(CSR_SparseMatrix_sp) :: matrix
      real(REAL32), allocatable :: vcoord_src(:), vcoord_dst(:)
      real(REAL32), allocatable :: fin(:), fout(:)
      real(REAL32), allocatable :: matrix(:, :)
      integer :: status

      vcoord_src = [30., 20., 10.]
      vcoord_dst = [20., 10.]
      call compute_linear_map_fixedlevels_to_fixedlevels(vcoord_src, vcoord_dst, matrix, _RC)
      @assertEqual(matmul(matrix, vcoord_src), vcoord_dst)

      fin = [7., 8., 3.]
      call apply_linear_map(matrix, fin, fout)
      @assertEqual(fout, [8., 3.])

      vcoord_src = [30., 20., 10.]
      vcoord_dst = [25., 15.]
      call compute_linear_map_fixedlevels_to_fixedlevels(vcoord_src, vcoord_dst, matrix, _RC)
      @assertEqual(matmul(matrix, vcoord_src), vcoord_dst)

      fin = [7., 8., 3.]
      call apply_linear_map(matrix, fin, fout)
      @assertEqual(fout, [7.5, 5.5])

   end subroutine test_linear_map_fixedlevels_to_fixedlevels

end module Test_WeightComputation
